#!/usr/bin/env bash
# Usage: script/version-changelog [version]
#
#   Inserts release notes for current release into changelog.
#   Release notes are expected to be at .git/RELNOTES
#   (generated by script/release-notes)
#
#   This script is intended to be invoked via the `version` npm lifecycle
#   script, which ensures the environment variable `npm_package_version` is set.
#   Alternatively, the new version can be provided as the first argument,
#   which (if provided) will take precedence over the env var.
#   Lastly, if not given an argument and `npm_package_version` is unset,
#   then version will be read from package.json.

set -euo pipefail
IFS=$'\n\t'

version_from_npm() {
  echo "${npm_package_version:-$(node -p 'require("./package").version')}"
}
NEW_VERSION=${1:-$(version_from_npm)}
RELNOTES="$(git rev-parse --git-dir)/RELNOTES"
CHANGELOG=docs/CHANGELOG.md
PREV_TAG="$(git describe --tags --match 'v*' --abbrev=0)"

sed -i '' -e "/## \\[Unreleased]/ {
  a \\
  \\
  ## [$NEW_VERSION](https://github.com/bats-core/bats-core/compare/$PREV_TAG...v$NEW_VERSION) - $(date -ju '+%Y-%m-%d')\\
  \\

  r $RELNOTES
}" $CHANGELOG

git add -- $CHANGELOG
